<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>使用Travis部署Hexo - </title>
        <meta name="Description" content="JOHHNYCHAN&#39;S HUGO BLOG"><meta property="og:title" content="使用Travis部署Hexo" />
<meta property="og:description" content="使用Travis平台的可持续集成服务来部署自己的Hexo博客。
环境说明
Github公开项目(Travis对开源项目是免费，对私有项目是收费的)
Linux服务器(这里用的阿里云的学生机，系统是CentOS 7.0)
终端连接器（用的是Manjaro终端直接连接）" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://chenjunxin.com/hugo/%E4%BD%BF%E7%94%A8travis%E9%83%A8%E7%BD%B2hexo/" />
<meta property="article:published_time" content="2020-02-06T21:24:06+00:00" />
<meta property="article:modified_time" content="2020-02-06T21:24:06+00:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="使用Travis部署Hexo"/>
<meta name="twitter:description" content="使用Travis平台的可持续集成服务来部署自己的Hexo博客。
环境说明
Github公开项目(Travis对开源项目是免费，对私有项目是收费的)
Linux服务器(这里用的阿里云的学生机，系统是CentOS 7.0)
终端连接器（用的是Manjaro终端直接连接）"/>
<meta name="application-name" content="LoveIt">
<meta name="apple-mobile-web-app-title" content="LoveIt"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://chenjunxin.com/hugo/%E4%BD%BF%E7%94%A8travis%E9%83%A8%E7%BD%B2hexo/" /><link rel="prev" href="https://chenjunxin.com/hugo/manjaro%E6%90%AD%E5%BB%BAsamba%E5%92%8Cdlna%E6%9C%8D%E5%8A%A1/" /><link rel="next" href="https://chenjunxin.com/hugo/hexo-next%E4%B8%BB%E9%A2%98%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE%E4%BC%98%E5%8C%96/" /><link rel="stylesheet" href="/hugo/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/hugo/css/style.min.css"><link rel="stylesheet" href="/hugo/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/hugo/lib/animate/animate.min.css"><meta name="google-site-verification" content="SEgZDIT-0OdxnPgHgsC3fOvdOF7O4zxgMnV25A4601U" /><meta name="baidu-site-verification" content="c694f10d0cd3c87d69a8be39bb4e7a46" /><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "使用Travis部署Hexo",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/chenjunxin.com\/hugo\/%E4%BD%BF%E7%94%A8travis%E9%83%A8%E7%BD%B2hexo\/"
        },"image": {
                "@type": "ImageObject",
                "url": "https:\/\/chenjunxin.com\/hugo\/cover.png",
                "width":  800 ,
                "height":  600 
            },"genre": "posts","keywords": "Travis","wordcount":  3902 ,
        "url": "https:\/\/chenjunxin.com\/hugo\/%E4%BD%BF%E7%94%A8travis%E9%83%A8%E7%BD%B2hexo\/","datePublished": "2020-02-06T21:24:06+00:00","dateModified": "2020-02-06T21:24:06+00:00","publisher": {
                "@type": "Organization",
                "name": "JohnnyChan",
                "logo": {
                "@type": "ImageObject",
                "url": "https:\/\/chenjunxin.com\/hugo\/logo.png",
                "width":  127 ,
                "height":  40 
                }
            },"author": {
                "@type": "Person",
                "name": "JohnnyChan"
            },"description": ""
    }
    </script></head>
    <body><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/hugo/" title=""></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/hugo/hugo/posts/"> 文章 </a><a class="menu-item" href="/hugo/hugo/tags/"> 标签 </a><a class="menu-item" href="/hugo/hugo/categories/"> 分类 </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/hugo/" title=""></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/hugo/hugo/posts/" title="">文章</a><a class="menu-item" href="/hugo/hugo/tags/" title="">标签</a><a class="menu-item" href="/hugo/hugo/categories/" title="">分类</a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">使用Travis部署Hexo</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/hugo/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>JohnnyChan</a></span>&nbsp;
                    <span class="post-category">收录于<a href="/hugo/categories/%E5%B7%A5%E5%85%B7/">
                                <i class="far fa-folder fa-fw"></i>工具
                            </a>&nbsp;<a href="/hugo/categories/travis/">
                                <i class="far fa-folder fa-fw"></i>Travis
                            </a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i><time datetime=2020-02-06>2020-02-06</time>&nbsp;
                <i class="fas fa-pencil-alt fa-fw"></i>约 3902 字&nbsp;
                <i class="far fa-clock fa-fw"></i>预计阅读 8 分钟&nbsp;</div>
        </div><div class="details toc" id="toc-static">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#生成公钥私钥对">生成公钥/私钥对</a></li>
    <li><a href="#安装travis客户端">安装Travis客户端</a>
      <ul>
        <li><a href="#安装ruby">安装ruby</a></li>
        <li><a href="#修改镜像源">修改镜像源</a></li>
        <li><a href="#安装travis命令行工具">安装Travis命令行工具</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p>使用Travis平台的可持续集成服务来部署自己的Hexo博客。</p>
<h1 id="环境说明">环境说明</h1>
<p>Github公开项目(Travis对开源项目是免费，对私有项目是收费的)
Linux服务器(这里用的阿里云的学生机，系统是CentOS 7.0)
终端连接器（用的是Manjaro终端直接连接）</p>
<h1 id="自动化部署流程">自动化部署流程</h1>
<ol>
<li>本地修改代码，提交到指定分支</li>
<li>Travis监听仓库改变</li>
<li>Travis执行install和script任务（这里可以做一些安装测试构建任务的依赖和测试构建命令。）</li>
<li>任务执行成功后，在Travis的 after_success 钩子里面用 ssh免密登陆 服务器</li>
<li>自动在服务器上执行配置的脚本</li>
</ol>
<h1 id="travis项目配置">Travis项目配置</h1>
<ol>
<li>在Github创建一个公有(public)仓库，然后访问官方网站travis-ci.org或者travis.com，推荐后一个，因为可以私有仓库（每个帐号一开始有100次私有仓库构建的体验服务）和公有仓库的构建都能一起管理，.org只能单看公有仓库的构建。点击右上角的个人头像，使用 Github 账户登入 Travis CI。
Travis 会列出 Github 上面你的所有仓库，以及你所属于的组织。此时，选择你需要 Travis 帮你构建的仓库，打开仓库旁边的开关。一旦激活了一个仓库，Travis 会监听这个仓库的所有变化。
假设现在已经对某个项目开启了 Travis，那么先去看看 Settings 里默认开启的那几项，根据自己实际需求进行设置，没什么特殊需求默认的设置就可以了。</li>
<li>创建添加 .travis.yml 到项目的根目录（稍后要提交到你关联的仓库中的）说白了接下来的事情都是如何去写这个配置文件，因为 Travis 全是根据这个配置文件去执行相应动作的。</li>
<li>在本地项目根目录的master分支里面添加 .travis.yml 配置文件，添加如下配置:</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="k">language</span><span class="p">:</span><span class="w"> </span>node_js<span class="w">   </span><span class="c">#前端工程所以是JavaScript，编译环境是node_js</span><span class="w">
</span><span class="w"></span><span class="k">node_js</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- <span class="m">12.14.1</span><span class="w">   </span><span class="c">#指定node版本</span><span class="w">
</span><span class="w"></span><span class="k">branchs</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">only</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- master<span class="w">  </span><span class="c">#指定只有检测到master分支有变动时才执行任务</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>将该配置文件推送到服务器。 返回Travis网站，此时Travis已经检测到该仓库的变动（有可能会有点延迟），所以会根据仓库根目录下的.travis.yml配置文件开始执行任务。
可以在Job log界面看任务执行时的输出，在View config的标签页下面看到此次任务的配置信息，包括了你在.travis.yml里面配置的和Travis自动配置的信息。
此时，Travis监听仓库变化，自动执行任务已经完成了，也就是流程中的前三步已经完成了。</p>
<h1 id="travis使用ssh免密登陆服务器">Travis使用SSH免密登陆服务器</h1>
<p>SSH的登陆原理看这个<a href="https://www.cnblogs.com/scofi/p/6617394.html" target="_blank" rel="noopener noreffer">SSH公钥登陆原理</a>。SSH录利用的是非对称加密的方式。基本步骤就是</p>
<ul>
<li>在客户端生成公钥和私钥</li>
<li>然后将私钥保存在客户端的~/.ssh/id_rsa中</li>
<li>将公钥保存在服务器的~/.ssh/authorized_keys文件中
更改文件的权限后，我们就能直接通过ssh免密登录我们的服务器。但是我们是无法操作travis的客户端的，但是如果我们了解ssh免密登录的原理后，你会发现公钥和私钥在什么地方生成都行，最重要的是两个要成对。</li>
</ul>
<p>ssh免密登录的大致过程就是：客户端向服务器发起登录请求，服务器向客户端返回一段随机字符串，客户端收到这段字符串后使用自己的私钥进行加密，然后发给服务器。服务器接收后使用自己保存的公钥解密，如果解密后的数据相等就登录成功，否则断开连接。</p>
<p>所以，公钥和私钥的生成我们完全可以在自己的服务器上进行操作。首先，登录到自己的服务器。</p>
<h2 id="生成公钥私钥对">生成公钥/私钥对</h2>
<p>这里直接在服务器上面生成密钥对，理论上在哪里生成密钥对都可以，只要是配套的。
用一个非root的常用用户或者新建一个用户，切到该用户下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 生成RSA密钥对，后面所有的直接以默认就行，passphase一定要为空</span>
$ ssh-keygen -t rsa
</code></pre></td></tr></table>
</div>
</div><p>可以看到生成密钥对在用户家目录的.ssh文件夹下面。 由于Linux权限的控制规则，文件的权限不是越大越好，所有需要设置合适的权限。这里需要把.ssh目录设置为700权限（可能默认就是），目录下面的文件设置为600权限。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ chmod <span class="m">600</span> ~/.ssh/*
</code></pre></td></tr></table>
</div>
</div><p>然后将生成的公钥(id_rsa.pub)中的内容添加到.ssh/authorized_keys中</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ touch ~/.ssh/authorized_keys
$ cat ~/.ssh/id_rsa.pub &gt;&gt;  ~/.ssh/authorized_keys
</code></pre></td></tr></table>
</div>
</div><p>到此，密钥对已经生成完成。下面，我们就需要测试一下免密登录的操作是否能成功。在.ssh目录下执行一下操作：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ touch config
</code></pre></td></tr></table>
</div>
</div><p>然后在config中添加如下内容:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">Host <span class="nb">test</span>
<span class="c1"># 换成需要登录的主机ip</span>
HostName <span class="nv">$IP</span>
<span class="c1"># 端口号</span>
Port <span class="m">6666</span>
<span class="c1"># 换成需要登录的用户名</span>
User <span class="nv">$UserName</span>
StrictHostKeyChecking no
IdentitiesOnly yes
<span class="c1"># 私钥的存放路径</span>
IdentityFile ~/.ssh/id_rsa
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ ssh <span class="nb">test</span>
</code></pre></td></tr></table>
</div>
</div><p>运行ssh test后报错Bad owner or permissions on ~/.ssh/config。这里同样要求我们要把.ssh/config和.ssh/authorized_keys权限设置为600。登录成功的花会有另外的信息，同时在.ssh/下多了一个known_hosts文件。</p>
<p>下面我们就需要将上面的密钥对中的私钥放在travis上，但是我们是无法直接操作travis服务器的，因此我们也就不能将私钥放在travis服务器上。但是，我们可以将私钥放在travis服务器能够读取的地方，因为travis是能够直接读取我们项目的工程的，所以，我们可以将私钥放在我们的项目中，travis提供了对私钥进行加密的功能，我们可以将私钥加密之后放在我们的工程中，当travis需要连接我们的服务器时，就解密这个私钥用于连接。</p>
<h2 id="安装travis客户端">安装Travis客户端</h2>
<h3 id="安装ruby">安装ruby</h3>
<p>Travis是通过gem进行安装的，<code>gem</code>是ruby的管理工具，所以我们需要先安装ruby。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ curl -sSL https://get.rvm.io <span class="p">|</span> bash -s stable
sudo yum install ruby <span class="c1">#这是centos系统下安装命令</span>
$ yum install rubygems
$ yum install ruby-devel
</code></pre></td></tr></table>
</div>
</div><p>查看RubyGems环境变量配置命令：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ which gem
</code></pre></td></tr></table>
</div>
</div><p>正确找到会输出内容 /usr/bin/gem，如果没有找，则需要进行环境变量的设置，有则无需设置了。</p>
<h3 id="修改镜像源">修改镜像源</h3>
<p>安装完ruby之后就可以使用gem包管理工具了，但是好像官方镜像源被墙了，所以需要更换gem的镜像源。参考<a href="https://gems.ruby-china.com/" target="_blank" rel="noopener noreffer">Ruby China</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ gem sources -l
*** CURRENT SOURCES ***

https://rubygems.org/
$ gem -v
2.7.7
<span class="c1">#更换镜像源</span>
$ gem sources --add https://gems.ruby-china.com/ --remove https://rubygems.org/
https://gems.ruby-china.com/ added to sources
https://rubygems.org/ removed from sources
$ gem sources -l
*** CURRENT SOURCES ***

https://gems.ruby-china.com/
</code></pre></td></tr></table>
</div>
</div><h3 id="安装travis命令行工具">安装Travis命令行工具</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ gem install travis
$ travis <span class="nb">help</span> <span class="c1">#测试travis客户端是否安装成功</span>
</code></pre></td></tr></table>
</div>
</div><p>将项目用git克隆到服务器上，进入到项目的根目录下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ travis login
或者运行以下其中一条命令，根据GitHub关联授权的travis网址后缀选择
$ travis login --com
$ travis login --org
<span class="c1"># 加密私钥匙并把的对应信息加入到.travis.yml中</span>
$ travis encrypt-file ~/.ssh/id_rsa  --add
</code></pre></td></tr></table>
</div>
</div><p>然后，你就会发现在项目的根目录下多了一个id_rsa.enc文件以及.travis.yml多了一个before_install指令</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ cat .travis.yml
language: node_js
node_js:
- 12.14.1
branchs:
  only:
  - master
before_install:
- openssl aes-256-cbc -K <span class="nv">$encrypted_311a3ff6a6ef_key</span> -iv <span class="nv">$encrypted_311a3ff6a6ef_iv</span>
  -in id_rsa.enc -out ~/.ssh/id_rsa -d
</code></pre></td></tr></table>
</div>
</div><p>解密命令中 -in 和 -out 参数:</p>
<ul>
<li>in 参数指定待解密的文件，位于仓库的根目录(Travis执行任务时会先把代码拉到Travis自己的服务器上，并进入仓库更目录)</li>
<li>out 参数指定解密后的密钥存放在Travis服务器的<code>~/.ssh/id_rsa</code>,需要手动将-out选项的值多了的一个\符号去掉</li>
</ul>
<p>然后将变更推送到master分支，触发travis构建。</p>
<h1 id="配置after_success">配置after_success</h1>
<p>到此，我们就差最后一个步骤了：在.travis.yml中添加一些配置，主要是after_success钩子配置。修改之后的配置如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="k">language</span><span class="p">:</span><span class="w"> </span>node_js<span class="w">
</span><span class="w"></span><span class="k">node_js</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- <span class="m">12.14.1</span><span class="w">
</span><span class="w"></span><span class="k">branchs</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">only</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- master<span class="w">  </span><span class="c">#设定分支</span><span class="w">
</span><span class="w"></span><span class="k">addons</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">ssh_known_hosts</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- $SERVER_IP<span class="w">  </span><span class="c">#受信主机，在使用 ssh 登陆时会确认主机信息，travis-ci 无法进行交互操作。所以需要在 .travis.yml 中添加addons:ssh_known_hosts</span><span class="w">
</span><span class="w"></span><span class="k">before_install</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- openssl<span class="w"> </span>aes<span class="m">-256</span>-cbc<span class="w"> </span>-K<span class="w"> </span>$encrypted_311a3ff6a6ef_key<span class="w"> </span>-iv<span class="w"> </span>$encrypted_311a3ff6a6ef_iv<span class="w">
</span><span class="w">  </span>-in<span class="w"> </span>id_rsa.enc<span class="w"> </span>-out<span class="w"> </span>~/.ssh/id_rsa<span class="w"> </span>-d<span class="w">
</span><span class="w"></span>- chmod<span class="w"> </span><span class="m">600</span><span class="w"> </span>~/.ssh/id_rsa<span class="w"> </span><span class="c">#还是Linux文件权限问题</span><span class="w">
</span><span class="w"></span>- echo<span class="w"> </span>-e<span class="w"> </span><span class="s2">&#34;Host &#34;</span>$SERVER_IP<span class="s2">&#34;\n\tStrictHostKeyChecking no\n&#34;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>~/.ssh/config<span class="w">
</span><span class="w"></span><span class="k">after_success</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- ssh<span class="w"> </span>chenjunxin@<span class="s2">&#34;$SERVER_IP&#34;</span><span class="w"> </span>-p<span class="w"> </span><span class="s2">&#34;$SERVER_PORT&#34;</span><span class="w"> </span>-o<span class="w"> </span>StrictHostKeyChecking=no<span class="w"> </span><span class="s1">&#39;. /home/chenjunxin/deploy/deployhexo.sh&#39;</span><span class="w">
</span><span class="w"></span><span class="c"># - ssh chenjunxin@&#34;$SERVER_IP&#34; -o StrictHostKeyChecking=no &#39;cd ~/hexo &amp;&amp; git pull &amp;&amp; npm install &amp;&amp; hexo clean &amp;&amp; hexo g&#39;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>ssh命令需要加上StrictHostKeyChecking=no选项，具体的可以查看禁用ssh远程主机的公钥检查。
可以直接在ssh连接后面写要运行的命令，也可以写在服务器上的shell文件里，然后远程登录执行。
after_success是在Travis执行完 install 和 script 之后执行的钩子,其他的Travis配置可以参考官方文档。
&ldquo;$SERVER_IP&rdquo;:这个值是Travis加密的值，可以设置在Job log中是否显示。可以在Travis控制台中的Setting中设置。
<img
        class="lazyload"
        src="/hugo/svg/loading/small.min.svg"
        data-src="https://oss.chenjunxin.com/picture/blogPicture/b69cbc2b_travis_dashboard_hexo_setting.webp"
        data-srcset="https://oss.chenjunxin.com/picture/blogPicture/b69cbc2b_travis_dashboard_hexo_setting.webp, https://oss.chenjunxin.com/picture/blogPicture/b69cbc2b_travis_dashboard_hexo_setting.webp 1.5x, https://oss.chenjunxin.com/picture/blogPicture/b69cbc2b_travis_dashboard_hexo_setting.webp 2x"
        data-sizes="auto"
        alt="https://oss.chenjunxin.com/picture/blogPicture/b69cbc2b_travis_dashboard_hexo_setting.webp"
        title="https://oss.chenjunxin.com/picture/blogPicture/b69cbc2b_travis_dashboard_hexo_setting.webp" />
也可以在服务器上运行以下命令（$IP填具体IP的值）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ travis encrypt  <span class="s2">&#34;SERVER_IP=</span><span class="nv">$IP</span><span class="s2">&#34;</span> --add
</code></pre></td></tr></table>
</div>
</div><p>命令执行之后会在.travis.yml新增一个sercure的值。
在运行的时候，Travis那边的服务器会分别从Setting设置与.travis.yml文件获取定义的变量值。更详细的内容可以查阅<a href="https://docs.travis-ci.com/user/environment-variables/" target="_blank" rel="noopener noreffer">官方文档</a></p>
<h1 id="一点补充">一点补充</h1>
<p>服务器上的travis客户端的配置文件在用户目录下的<code>$HOME/.travis/</code>中。其中的config。yml里可以 endpoint可以配置数据库构建的地址，可以是<a href="https://api.travis-ci.com/" target="_blank" rel="noopener noreffer">https://api.travis-ci.com/</a> 或者 <a href="https://api.travis-ci.com/" target="_blank" rel="noopener noreffer">https://api.travis-ci.com/</a></p>
<h1 id="参考链接">参考链接</h1>
<ul>
<li><a href="https://www.itfanr.cc/2017/08/09/using-travis-ci-automatic-deploy-hexo-blogs/" target="_blank" rel="noopener noreffer">使用Travis CI自动部署Hexo博客</a></li>
<li><a href="https://www.dazhuanlan.com/2019/10/15/5da588149783f/" target="_blank" rel="noopener noreffer">travis自动化部署github项目到server</a></li>
<li><a href="https://changkun.us/archives/2017/06/232/" target="_blank" rel="noopener noreffer">Hexo + GitHub + Travis CI + VPS 自动部署</a></li>
<li><a href="https://www.jonhuu.com/sample-post/1108.html" target="_blank" rel="noopener noreffer">Travis CI 系列自动化部署测试教程（VPS服务器）</a></li>
<li><a href="https://andyliwr.github.io/2018/04/28/travis_node_publish2/" target="_blank" rel="noopener noreffer">travis自动化部署续篇</a></li>
<li><a href="https://juejin.im/post/5a9e1a5751882555712bd8e1" target="_blank" rel="noopener noreffer">Travis-CI自动化测试并部署至自己的CentOS服务器</a></li>
<li><a href="https://cnodejs.org/topic/5885f19c171f3bc843f6017e" target="_blank" rel="noopener noreffer">利用travis-ci持续部署nodejs应用</a></li>
<li><a href="http://www.worldhello.net/2010/04/08/1026.html" target="_blank" rel="noopener noreffer">禁用SSH远程主机的公钥检查</a></li>
<li><a href="https://blog.csdn.net/bingguang1993/article/details/82415543" target="_blank" rel="noopener noreffer">解决linux中ssh登录Warning:Permanently added (RSA) to the list of known hosts</a></li>
<li><a href="http://www.cocoachina.com/articles/24904" target="_blank" rel="noopener noreffer">TrueChain持续集成项目打包（Travis-CI）</a></li>
</ul></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>本文于 2020-02-06 更新</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/hugo/%E4%BD%BF%E7%94%A8travis%E9%83%A8%E7%BD%B2hexo/index.md" target="_blank">阅读原始文档</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="https://chenjunxin.com/hugo/%E4%BD%BF%E7%94%A8travis%E9%83%A8%E7%BD%B2hexo/" data-title="使用Travis部署Hexo" data-hashtags="Travis"><i class="fab fa-twitter fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="https://chenjunxin.com/hugo/%E4%BD%BF%E7%94%A8travis%E9%83%A8%E7%BD%B2hexo/" data-hashtag="Travis"><i class="fab fa-facebook-square fa-fw"></i></a><a href="javascript:void(0);" title="分享到 WhatsApp" data-sharer="whatsapp" data-url="https://chenjunxin.com/hugo/%E4%BD%BF%E7%94%A8travis%E9%83%A8%E7%BD%B2hexo/" data-title="使用Travis部署Hexo" data-web><i class="fab fa-whatsapp fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Line" data-sharer="line" data-url="https://chenjunxin.com/hugo/%E4%BD%BF%E7%94%A8travis%E9%83%A8%E7%BD%B2hexo/" data-title="使用Travis部署Hexo"><i class="fab fa-line fa-fw"></i></a><a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="https://chenjunxin.com/hugo/%E4%BD%BF%E7%94%A8travis%E9%83%A8%E7%BD%B2hexo/" data-title="使用Travis部署Hexo"><i class="fab fa-weibo fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Myspace" data-sharer="myspace" data-url="https://chenjunxin.com/hugo/%E4%BD%BF%E7%94%A8travis%E9%83%A8%E7%BD%B2hexo/" data-title="使用Travis部署Hexo" data-description=""><i data-svg-src="/hugo/lib/simple-icons/icons/myspace.min.svg"></i></a><a href="javascript:void(0);" title="分享到 Blogger" data-sharer="blogger" data-url="https://chenjunxin.com/hugo/%E4%BD%BF%E7%94%A8travis%E9%83%A8%E7%BD%B2hexo/" data-title="使用Travis部署Hexo" data-description=""><i class="fab fa-blogger fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Evernote" data-sharer="evernote" data-url="https://chenjunxin.com/hugo/%E4%BD%BF%E7%94%A8travis%E9%83%A8%E7%BD%B2hexo/" data-title="使用Travis部署Hexo"><i class="fab fa-evernote fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/hugo/tags/travis/">Travis</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/hugo/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/hugo/manjaro%E6%90%AD%E5%BB%BAsamba%E5%92%8Cdlna%E6%9C%8D%E5%8A%A1/" class="prev" rel="prev" title="Manjaro搭建Samba和DLNA服务"><i class="fas fa-angle-left fa-fw"></i>Manjaro搭建Samba和DLNA服务</a>
            <a href="/hugo/hexo-next%E4%B8%BB%E9%A2%98%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE%E4%BC%98%E5%8C%96/" class="next" rel="next" title="Hexo-NexT (v7.7.0) 主题安装配置优化">Hexo-NexT (v7.7.0) 主题安装配置优化<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id="comments"></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.69.1">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.5"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2017 - 2020</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/hugo/" target="_blank">JohnnyChan</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span><span class="icp-splitter">&nbsp;|&nbsp;</span><br class="icp-br"/>
                    <span class="icp">粤ICP备17106857号-2</span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/hugo/lib/katex/katex.min.css"><link rel="stylesheet" href="/hugo/lib/katex/copy-tex.min.css"><script type="text/javascript">
    window.config = {"code":{"copyTitle":"复制到剪贴板","maxShownLines":10},"comment":{},"headerMode":{"desktop":"fixed","mobile":"auto"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","lunrIndexURL":"/hugo/index.json","lunrLanguageCode":"zh","lunrSegmentitURL":"/hugo/lib/lunr/lunr.segmentit.js","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"lunr"}};
</script><script type="text/javascript" src="https://polyfill.io/v3/polyfill.min.js?features=html5shiv%2CElement.prototype.closest%2CrequestAnimationFrame%2CCustomEvent%2CPromise%2CObject.entries%2CObject.assign%2CObject.values%2Cfetch%2CElement.prototype.after%2CArray.prototype.fill%2CIntersectionObserver%2CArray.from%2CArray.prototype.find%2CMath.sign"></script><script type="text/javascript" src="/hugo/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/hugo/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/hugo/lib/lunr/lunr.min.js"></script><script type="text/javascript" src="/hugo/lib/lunr/lunr.stemmer.support.min.js"></script><script type="text/javascript" src="/hugo/lib/lunr/lunr.zh.min.js"></script><script type="text/javascript" src="/hugo/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/hugo/lib/object-fit-images/ofi.min.js"></script><script type="text/javascript" src="/hugo/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/hugo/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/hugo/lib/katex/katex.min.js"></script><script type="text/javascript" src="/hugo/lib/katex/auto-render.min.js"></script><script type="text/javascript" src="/hugo/lib/katex/copy-tex.min.js"></script><script type="text/javascript" src="/hugo/lib/katex/mhchem.min.js"></script><script type="text/javascript" src="/hugo/js/theme.min.js"></script></body>
</html>
